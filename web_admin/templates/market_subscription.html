<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行情订阅管理 - ARBIG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .subscription-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        .subscription-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .contract-badge {
            font-size: 1.1em;
            padding: 8px 12px;
        }
        .price-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            font-weight: bold;
        }
        .price-up { color: #dc3545; }
        .price-down { color: #28a745; }
        .price-flat { color: #6c757d; }
        .add-contract-form {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>ARBIG 行情订阅管理
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>首页</a>
                <a class="nav-link" href="/services"><i class="fas fa-cogs me-1"></i>服务管理</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 添加新合约订阅 -->
        <div class="add-contract-form">
            <h4><i class="fas fa-plus-circle me-2"></i>添加行情订阅</h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="contractInput" class="form-label">合约代码</label>
                        <input type="text" class="form-control" id="contractInput" 
                               placeholder="输入合约代码，如: au2509" maxlength="10">
                        <div class="form-text">支持黄金期货合约，如: au2509, au2512, au2601</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">或从发现的合约中选择</label>
                        <select class="form-select" id="contractSelect">
                            <option value="">-- 选择合约 --</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="saveToConfig" checked>
                        <label class="form-check-label" for="saveToConfig">
                            保存为主力合约（下次启动自动订阅）
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-primary" onclick="subscribeContract()">
                        <i class="fas fa-plus me-1"></i>订阅行情
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="loadAvailableContracts()">
                        <i class="fas fa-sync me-1"></i>刷新合约列表
                    </button>
                </div>
            </div>
        </div>

        <!-- 当前订阅列表 -->
        <div class="row">
            <div class="col-12">
                <h4><i class="fas fa-list me-2"></i>当前订阅合约</h4>
                <div id="subscriptionsList" class="row">
                    <!-- 动态加载订阅列表 -->
                </div>
            </div>
        </div>

        <!-- 主力合约配置 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-star me-2"></i>主力合约配置</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">主力合约会在系统启动时自动订阅，并保存在配置文件中。</p>
                        <div id="mainContractsList">
                            <!-- 动态加载主力合约列表 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功/错误提示模态框 -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageModalTitle">提示</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="messageModalBody">
                    <!-- 动态内容 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscriptions();
            loadMainContracts();
            loadAvailableContracts();
            
            // 定时刷新行情数据
            setInterval(updatePrices, 5000);
        });

        // 加载当前订阅列表
        async function loadSubscriptions() {
            try {
                const response = await fetch('/api/v1/data/market/subscriptions');
                const data = await response.json();
                
                if (data.success) {
                    displaySubscriptions(data.data.subscriptions || []);
                } else {
                    console.error('加载订阅列表失败:', data.message);
                }
            } catch (error) {
                console.error('加载订阅列表错误:', error);
            }
        }

        // 显示订阅列表
        function displaySubscriptions(subscriptions) {
            const container = document.getElementById('subscriptionsList');
            
            if (subscriptions.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>暂无订阅的合约
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = subscriptions.map(sub => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card subscription-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-primary contract-badge">${sub.symbol}</span>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="unsubscribeContract('${sub.symbol}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="price-display price-flat" id="price-${sub.symbol}">
                                ---.--
                            </div>
                            <small class="text-muted">订阅者: ${sub.subscribers ? sub.subscribers.join(', ') : 'system'}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 订阅合约
        async function subscribeContract() {
            const contractInput = document.getElementById('contractInput').value.trim();
            const contractSelect = document.getElementById('contractSelect').value;
            const saveToConfig = document.getElementById('saveToConfig').checked;
            
            const symbol = contractInput || contractSelect;
            
            if (!symbol) {
                showMessage('错误', '请输入或选择要订阅的合约代码', 'danger');
                return;
            }

            try {
                const response = await fetch('/api/v1/data/market/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        subscriber_id: 'web_admin',
                        save_to_config: saveToConfig
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('成功', `合约 ${symbol} 订阅成功！`, 'success');
                    document.getElementById('contractInput').value = '';
                    document.getElementById('contractSelect').value = '';
                    loadSubscriptions();
                    if (saveToConfig) {
                        loadMainContracts();
                    }
                } else {
                    showMessage('错误', `订阅失败: ${data.message}`, 'danger');
                }
            } catch (error) {
                showMessage('错误', `订阅失败: ${error.message}`, 'danger');
            }
        }

        // 取消订阅
        async function unsubscribeContract(symbol) {
            if (!confirm(`确定要取消订阅合约 ${symbol} 吗？`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/data/market/unsubscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        subscriber_id: 'web_admin'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('成功', `合约 ${symbol} 取消订阅成功！`, 'success');
                    loadSubscriptions();
                } else {
                    showMessage('错误', `取消订阅失败: ${data.message}`, 'danger');
                }
            } catch (error) {
                showMessage('错误', `取消订阅失败: ${error.message}`, 'danger');
            }
        }

        // 显示消息
        function showMessage(title, message, type) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalBody').innerHTML = `
                <div class="alert alert-${type} mb-0">
                    ${message}
                </div>
            `;
            new bootstrap.Modal(document.getElementById('messageModal')).show();
        }

        // 加载主力合约配置
        async function loadMainContracts() {
            try {
                const response = await fetch('/api/v1/system/config/market_data');
                const data = await response.json();

                if (data.success) {
                    const mainContracts = data.data.main_contracts || [];
                    displayMainContracts(mainContracts);
                } else {
                    console.error('加载主力合约配置失败:', data.message);
                }
            } catch (error) {
                console.error('加载主力合约配置错误:', error);
            }
        }

        // 显示主力合约
        function displayMainContracts(contracts) {
            const container = document.getElementById('mainContractsList');

            if (contracts.length === 0) {
                container.innerHTML = '<p class="text-muted">暂无配置的主力合约</p>';
                return;
            }

            container.innerHTML = contracts.map(contract => `
                <span class="badge bg-warning text-dark me-2 mb-2" style="font-size: 1em; padding: 8px 12px;">
                    <i class="fas fa-star me-1"></i>${contract}
                    <button class="btn btn-sm btn-link text-dark p-0 ms-2"
                            onclick="removeMainContract('${contract}')"
                            title="从主力合约中移除">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join('');
        }

        // 加载可用合约列表
        async function loadAvailableContracts() {
            try {
                const response = await fetch('/api/v1/data/market/available_contracts');
                const data = await response.json();

                if (data.success) {
                    const contracts = data.data.contracts || [];
                    const select = document.getElementById('contractSelect');

                    select.innerHTML = '<option value="">-- 选择合约 --</option>';
                    contracts.forEach(contract => {
                        select.innerHTML += `<option value="${contract}">${contract}</option>`;
                    });
                } else {
                    console.error('加载可用合约失败:', data.message);
                }
            } catch (error) {
                console.error('加载可用合约错误:', error);
            }
        }

        // 更新价格显示
        async function updatePrices() {
            try {
                const response = await fetch('/api/v1/data/market/latest_prices');
                const data = await response.json();

                if (data.success) {
                    const prices = data.data.prices || {};

                    Object.keys(prices).forEach(symbol => {
                        const priceElement = document.getElementById(`price-${symbol}`);
                        if (priceElement) {
                            const price = prices[symbol];
                            priceElement.textContent = price.last_price || '---.--';

                            // 根据涨跌设置颜色
                            priceElement.className = 'price-display ';
                            if (price.change > 0) {
                                priceElement.className += 'price-up';
                            } else if (price.change < 0) {
                                priceElement.className += 'price-down';
                            } else {
                                priceElement.className += 'price-flat';
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('更新价格失败:', error);
            }
        }

        // 从主力合约中移除
        async function removeMainContract(symbol) {
            if (!confirm(`确定要从主力合约配置中移除 ${symbol} 吗？`)) {
                return;
            }

            try {
                const response = await fetch('/api/v1/system/config/market_data/remove_main_contract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('成功', `已从主力合约配置中移除 ${symbol}`, 'success');
                    loadMainContracts();
                } else {
                    showMessage('错误', `移除失败: ${data.message}`, 'danger');
                }
            } catch (error) {
                showMessage('错误', `移除失败: ${error.message}`, 'danger');
            }
        }
    </script>
</body>
</html>
