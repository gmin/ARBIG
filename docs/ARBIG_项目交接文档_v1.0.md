# ARBIG项目交接文档 v1.0

**创建时间**: 2025-09-05  
**项目状态**: 策略测试阶段 - 正在解决多开多单Bug

---

## 🎯 项目概述

### 系统架构
- **项目名称**: ARBIG - 黄金期货量化交易系统
- **技术栈**: Python + vnpy + CTP
- **架构模式**: 微服务架构 (交易服务 + 策略服务)
- **交易品种**: 黄金期货 au2510 (上期所)
- **部署环境**: Linux服务器，端口8001(交易)，8002(策略)

### 核心数据流
```
CTP行情/交易 → 交易服务(8001) → 策略服务(8002) → 策略实例 → 交易信号 → CTP执行
```

---

## 🔧 最近完成的重大优化

### 架构简化 (v2.0)
1. **移除成交数据轮询** - 不再轮询成交数据，减少HTTP请求
2. **实时持仓查询** - 策略主动查询CTP真实持仓
3. **纯净回调系统** - 行情回调专注信号生成，订单回调只处理关键状态
4. **删除200+行复杂代码** - 大幅简化系统架构

### 策略重构
- **SimpleSHFEStrategy** → **MaRsiComboStrategy** (MA+RSI组合策略)
- **集成优化架构** - 持仓缓存、实时查询、安全风控
- **专注黄金交易** - 针对黄金期货特性优化参数

---

## 🚨 当前核心问题：多开多单Bug

### 问题描述
- **现象**: 策略决策保持空单，但系统执行了意外的多单开仓
- **影响**: 导致持仓与策略预期不符，风控失效

### 关键日志证据
```
文件: logs/gold_arbitrage_20250904-2.log
时间: 2025-09-05 00:48:00 - 00:49:13

关键日志:
- 00:48:00,294 - 查询到真实持仓: 多单=0, 空单=1, 净持仓=-1
- 00:49:00,493 - 生成交易信号: SELL - 弱空头信号
- 00:49:00,496 - 弱信号，保持空头持仓1手  ← 策略决策正确
- 00:49:13,573 - 方向: Direction.LONG  ← 意外出现多单成交
```

### 根本原因分析
1. **on_bar重复调用** - 同一K线被处理多次，产生重复信号
2. **日志重复** - 每个处理步骤都有重复日志，证明重复调用
3. **信号处理混乱** - 重复的信号处理可能导致意外交易

---

## ✅ 已采取的解决措施

### 1. 修复重复调用问题
```python
# 策略类修改：删除on_bar方法，只保留on_bar_impl
def on_bar_impl(self, bar: BarData):  # ← 避免重复调用
    """基类ARBIGCtaTemplate中on_bar方法调用的实现"""
```

### 2. 限制tick数据分发
```python
# strategy_engine.py修改：只给测试策略发送tick
if strategy_name == "TestSystem":
    strategy.on_tick(tick)  # ← 技术分析策略只接收K线
```

### 3. 简化开平仓逻辑
```python
# cta_template.py修改：简化枚举处理
if trade.offset == "OPEN":  # ← 改回字符串比较
```

---

## 📁 关键文件状态

### 策略文件
- **MaRsiComboStrategy.py** - 主要测试策略，已修复on_bar重复调用
- **SystemIntegrationTestStrategy.py** - 系统集成测试策略
- **其他策略** - MaCrossoverTrendStrategy等，待测试

### 核心服务
- **strategy_engine.py** - 已优化，移除成交轮询，限制tick分发
- **cta_template.py** - 简化开平仓逻辑，修复枚举问题
- **real_trading.py** - 调整信号转换逻辑
- **ctp_integration.py** - 移除AUTO自动平仓映射

---

## 🧪 当前测试配置

### 测试策略
- **策略名称**: GoldMaRsi
- **策略类型**: MaRsiComboStrategy
- **交易品种**: au2510
- **关键参数**:
  - MA短期: 5, MA长期: 20
  - RSI周期: 14 (超买70, 超卖30)
  - 最大持仓: 5手
  - 止损: 2%, 止盈: 3%

### 启动命令
```bash
# 注册策略
curl -X POST "http://localhost:8002/strategies/register" \
  -H "Content-Type: application/json" \
  -d '{"strategy_name": "GoldMaRsi", "strategy_type": "MaRsiComboStrategy", "symbol": "au2510", "params": {...}}'

# 启动策略  
curl -X POST "http://localhost:8002/strategies/GoldMaRsi/start"
```

---

## 🔍 待验证的关键点

### 1. 重复调用修复验证
- [ ] 确认日志不再重复
- [ ] 验证每个K线只处理一次
- [ ] 检查信号生成的唯一性

### 2. 信号执行一致性
- [ ] 策略决策与实际执行的一致性
- [ ] 开平仓转换的正确性
- [ ] 持仓管理的准确性

### 3. 系统稳定性
- [ ] 长时间运行的稳定性
- [ ] 异常情况的处理能力
- [ ] 风控机制的有效性

---

## 🚀 下一步工作计划

### 立即任务
1. **测试修复效果** - 启动MaRsiComboStrategy验证bug修复
2. **监控关键日志** - 重点关注信号生成和执行的一致性
3. **验证持仓管理** - 确保策略持仓与CTP持仓同步

### 后续优化
1. **清理重复日志** - 统一日志格式和级别
2. **完善错误处理** - 增强系统容错能力
3. **性能优化** - 进一步提升系统效率

---

## 📞 技术债务清单

- **日志系统** - 重复日志、格式不统一
- **枚举处理** - 字符串和枚举类型混用
- **错误处理** - 异常处理机制不完善
- **测试覆盖** - 缺少自动化测试

---

**文档版本**: v1.0  
**最后更新**: 2025-09-05  
**状态**: 等待验证多开多单Bug修复效果

**关键提醒**: 重点关注 `logs/gold_arbitrage_20250904-2.log` 中的问题模式，确保修复后不再出现类似的重复调用和意外交易。
