# ARBIG 当前系统架构文档

## 📋 文档信息

- **版本**: v3.1 (三服务微服务架构)
- **更新日期**: 2025-08-15
- **架构类型**: 微服务架构
- **状态**: ✅ 当前有效

## 🎯 架构概述

ARBIG 系统采用**微服务架构**，将系统拆分为独立的服务组件，每个服务运行在独立的进程中，通过HTTP API进行通信。

### 🏗️ 核心设计原则

1. **服务独立**: 每个服务独立部署、独立扩展
2. **职责分离**: 交易逻辑与Web界面分离
3. **API驱动**: 服务间通过REST API通信
4. **统一启动**: 通过start.py统一管理服务生命周期

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    ARBIG 微服务架构 v3.1                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐         ┌─────────────────────┐        │
│  │  Web管理服务         │   HTTP  │   核心交易服务       │        │
│  │  (Port 80)          │◄───────►│   (Port 8001)       │        │
│  │                     │   API   │                     │        │
│  │ services/           │         │ services/           │        │
│  │ web_admin_service/  │         │ trading_service/    │        │
│  │                     │         │                     │        │
│  │ • 用户界面           │         │ • CTP连接           │        │
│  │ • 交易页面           │         │ • 持仓管理           │        │
│  │ • 系统监控           │         │ • 智能平仓           │        │
│  │ • API路由           │         │ • 交易执行           │        │
│  │ • 静态资源           │         │ • 今昨仓处理         │        │
│  └─────────────────────┘         └─────────────────────┘        │
│           │                               │                     │
│           │                               │                     │
│           │       ┌─────────────────────┐ │                     │
│           │ HTTP  │   策略管理服务       │ │                     │
│           └──────►│   (Port 8002)       │◄┘                     │
│             API   │                     │                       │
│                   │ services/           │                       │
│                   │ strategy_service/   │                       │
│                   │                     │                       │
│                   │ • 策略配置           │                       │
│                   │ • 策略监控           │                       │
│                   │ • 策略控制           │                       │
│                   │ • SHFE黄金策略       │                       │
│                   └─────────────────────┘                       │
│           │                               │                     │
│           └───────────────┬───────────────┘                     │
│                           ▼                                     │
│                  ┌─────────────────┐                            │
│                  │   共享组件       │                            │
│                  │                 │                            │
│                  │ • config/       │                            │
│                  │ • core/         │                            │
│                  │ • utils/        │                            │
│                  │ • shared/       │                            │
│                  └─────────────────┘                            │
│                           │                                     │
│                           ▼                                     │
│                  ┌─────────────────┐                            │
│                  │   外部接口       │                            │
│                  │                 │                            │
│                  │ • CTP Gateway   │                            │
│                  │ • 上期所(SHFE)   │                            │
│                  │ • 数据库         │                            │
│                  └─────────────────┘                            │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 服务详细说明

### 1. 核心交易服务 (services/trading_service/)

**端口**: 8001  
**职责**: 核心交易逻辑和数据处理

#### 核心功能
- **CTP连接管理**: 维护与上期所的交易和行情连接
- **行情数据处理**: 实时行情订阅、数据分发
- **账户管理**: 资金查询、持仓管理
- **交易执行**: 下单、撤单、订单状态管理
- **风控检查**: 交易前风险控制
- **API服务**: 提供REST API供Web服务调用

#### 主要API端点
```
GET  /real_trading/status          # 系统状态
GET  /real_trading/account         # 账户信息
GET  /real_trading/positions       # 持仓信息
POST /real_trading/order           # 下单
GET  /real_trading/orders          # 订单查询
GET  /real_trading/market_data     # 行情数据
```

#### 启动命令
```bash
python services/trading_service/main.py --port 8001
```

### 2. Web管理服务 (services/web_admin_service/)

**端口**: 80  
**职责**: 用户界面和系统管理

#### 核心功能
- **Web界面**: 提供完整的Web管理界面
- **用户交互**: 交易页面、系统监控页面
- **API代理**: 将前端请求转发到交易服务
- **静态资源**: 服务HTML、CSS、JavaScript文件
- **实时通信**: WebSocket支持(规划中)

#### 主要页面
```
/                    # 首页 - 系统概览
/trading             # 交易页面 - 手动交易
/docs                # API文档 (重定向到8001端口)
```

#### API路由
```
/api/v1/trading/*    # 代理到交易服务的API
```

#### 启动命令
```bash
python services/web_admin_service/main.py --port 80
```

## 🚀 系统启动

### 统一启动 (推荐)
```bash
cd /root/ARBIG
conda activate vnpy
python start.py --mode full --auto
```

### 手动启动
```bash
# 1. 启动交易服务 (必须先启动)
python services/trading_service/main.py --port 8001

# 2. 启动Web服务
python services/web_admin_service/main.py --port 80
```

## 📊 服务依赖关系

```
start.py (服务编排器)
    ├── 检查环境和配置
    ├── 启动交易服务 (8001)
    ├── 启动Web服务 (80)
    └── 监控服务状态

Web服务 (80) ──API调用──► 交易服务 (8001)
    │                           │
    ├── 用户界面                 ├── CTP连接
    ├── 静态资源                 ├── 行情处理
    └── API代理                 └── 交易执行
```

## 🔄 数据流

### 1. 行情数据流
```
上期所 → CTP Gateway → 交易服务 → Web服务 → 用户界面
```

### 2. 交易指令流
```
用户界面 → Web服务 → 交易服务 → CTP Gateway → 上期所
```

### 3. 账户数据流
```
上期所 → CTP Gateway → 交易服务 → Web服务 → 用户界面
```

## 📁 目录结构

```
/root/ARBIG/
├── start.py                    # 🚀 统一启动脚本
├── services/                   # 🏗️ 微服务目录
│   ├── trading_service/        # 📊 核心交易服务
│   │   ├── main.py            # 服务入口
│   │   ├── api/               # API路由
│   │   ├── core/              # 核心逻辑
│   │   └── utils/             # 工具函数
│   └── web_admin_service/      # 🎛️ Web管理服务
│       ├── main.py            # 服务入口
│       ├── api/               # API路由
│       ├── static/            # 静态资源
│       └── templates/         # HTML模板
├── config/                     # ⚙️ 配置文件
│   ├── config.py              # 主配置
│   └── ctp_sim.json           # CTP配置
├── core/                       # 🔧 共享核心组件
├── shared/                     # 📦 共享模块
├── utils/                      # 🛠️ 工具函数
└── tests/                      # 🧪 测试文件
```

## 🔧 配置管理

### 主配置文件: config/config.py
- 主力合约配置
- 支持合约列表
- 系统参数

### CTP配置文件: config/ctp_sim.json
- CTP连接参数
- 服务器地址
- 用户认证信息

## 🛡️ 安全考虑

1. **服务隔离**: 交易逻辑与Web界面分离
2. **API认证**: 内部API调用(规划中)
3. **端口管理**: 明确的端口分配
4. **配置安全**: 敏感配置文件保护

## 📈 扩展性

### 水平扩展
- 可以部署多个交易服务实例
- 可以部署多个Web服务实例
- 通过负载均衡器分发请求

### 垂直扩展
- 独立调整各服务的资源配置
- 针对性能瓶颈进行优化

## 🔍 监控和诊断

### 健康检查
```bash
# 检查服务状态
curl http://localhost:8001/real_trading/status
curl http://localhost/api/v1/trading/config/main_contract

# 检查端口
netstat -tlnp | grep -E "(80|8001)"
```

### 日志管理
- 各服务独立的日志文件
- 统一的日志格式
- 日志轮转和归档

## 🚀 部署建议

### 开发环境
- 单机部署，所有服务在同一台机器
- 使用start.py统一启动

### 生产环境
- 服务分离部署
- 使用进程管理器(如systemd)
- 配置反向代理(如nginx)
- 实施监控和告警

---

**📝 注意**: 这是当前系统的实际架构文档。如需了解历史架构演进，请参考docs/archive/目录下的历史文档。
